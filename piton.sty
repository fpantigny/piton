%%
%% This is file `piton.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% piton.dtx  (with options: `STY')
%% -------------------------------------------
%% Copyright (C) 2022-2024 by F. Pantigny
%% 
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either
%% version 1.3 of this license or (at your option) any later
%% version.  The latest version of this license is in:
%% 
%%      http://www.latex-project.org/lppl.txt
%% 
%% and version 1.3 or later is part of all distributions of
%% LaTeX version 2005/12/01 or later.
%% -------------------------------------------
%% 
\def\PitonFileVersion{2.4}
\def\PitonFileDate{2024/01/15}


\NeedsTeXFormat{LaTeX2e}
\RequirePackage{l3keys2e}
\ProvidesExplPackage
  {piton}
  {\PitonFileDate}
  {\PitonFileVersion}
  {Highlight Python codes with LPEG on LuaLaTeX}
\cs_new_protected:Npn \__piton_error:n { \msg_error:nn { piton } }
\cs_new_protected:Npn \__piton_warning:n { \msg_warning:nn { piton } }
\cs_new_protected:Npn \__piton_error:nn { \msg_error:nnn { piton } }
\cs_new_protected:Npn \__piton_error:nnn { \msg_error:nnnn { piton } }
\cs_new_protected:Npn \__piton_fatal:n { \msg_fatal:nn { piton } }
\cs_new_protected:Npn \__piton_fatal:nn { \msg_fatal:nnn { piton } }
\cs_new_protected:Npn \__piton_msg_new:nn { \msg_new:nnn { piton } }
\cs_new_protected:Npn \__piton_msg_new:nnn { \msg_new:nnnn { piton } }
\cs_new_protected:Npn \__piton_gredirect_none:n #1
  {
    \group_begin:
    \globaldefs = 1
    \msg_redirect_name:nnn { piton } { #1 } { none }
    \group_end:
  }
\__piton_msg_new:nn { LuaLaTeX~mandatory }
  {
    LuaLaTeX~is~mandatory.\\
    The~package~'piton'~requires~the~engine~LuaLaTeX.\\
    \str_if_eq:onT \c_sys_jobname_str { output }
      { If~you~use~Overleaf,~you~can~switch~to~LuaLaTeX~in~the~"Menu". \\}
    If~you~go~on,~the~package~'piton'~won't~be~loaded.
  }
\sys_if_engine_luatex:F { \msg_critical:nn { piton } { LuaLaTeX~mandatory } }
\RequirePackage { luatexbase }
\__piton_msg_new:nnn { piton.lua~not~found }
  {
    The~file~'piton.lua'~can't~be~found.\\
    The~package~'piton'~won't~be~loaded.\\
    If~you~want~to~know~how~to~retrieve~the~file~'piton.lua',~type~H~<return>.
  }
  {
    On~the~site~CTAN,~go~to~the~page~of~'piton':~https://ctan.org/pkg/piton.~
    The~file~'README.md'~explains~how~to~retrieve~the~files~'piton.sty'~and~
    'piton.lua'.
  }
\file_if_exist:nF { piton.lua }
  { \msg_critical:nn { piton } { piton.lua~not~found } }
\bool_new:N \g__piton_footnotehyper_bool
\bool_new:N \g__piton_footnote_bool
\bool_new:N \g__piton_math_comments_bool
\bool_new:N \g__piton_beamer_bool
\tl_new:N \g__piton_escape_inside_tl
\keys_define:nn { piton / package }
  {
    footnote .bool_gset:N = \g__piton_footnote_bool ,
    footnotehyper .bool_gset:N = \g__piton_footnotehyper_bool ,

    beamer .bool_gset:N = \g__piton_beamer_bool ,
    beamer .default:n = true ,

    math-comments .code:n = \__piton_error:n { moved~to~preamble } ,
    comment-latex .code:n = \__piton_error:n { moved~to~preamble } ,

    unknown .code:n = \__piton_error:n { Unknown~key~for~package }
  }
\__piton_msg_new:nn { moved~to~preamble }
  {
    The~key~'\l_keys_key_str'~*must*~now~be~used~with~
    \token_to_str:N \PitonOptions`in~the~preamble~of~your~
    document.\\
    That~key~will~be~ignored.
  }
\__piton_msg_new:nn { Unknown~key~for~package }
  {
    Unknown~key.\\
    You~have~used~the~key~'\l_keys_key_str'~but~the~only~keys~available~here~
    are~'beamer',~'footnote',~'footnotehyper'.~Other~keys~are~available~in~
    \token_to_str:N \PitonOptions.\\
    That~key~will~be~ignored.
  }
\ProcessKeysOptions { piton / package }
\@ifclassloaded { beamer } { \bool_gset_true:N \g__piton_beamer_bool } { }
\@ifpackageloaded { beamerarticle } { \bool_gset_true:N \g__piton_beamer_bool } { }
\bool_if:NT \g__piton_beamer_bool { \lua_now:n { piton_beamer = true } }
\hook_gput_code:nnn { begindocument } { . }
  {
    \@ifpackageloaded { xcolor }
      { }
      { \msg_fatal:nn { piton } { xcolor~not~loaded } }
  }
\__piton_msg_new:nn { xcolor~not~loaded }
  {
    xcolor~not~loaded \\
    The~package~'xcolor'~is~required~by~'piton'.\\
    This~error~is~fatal.
  }
\__piton_msg_new:nn { footnote~with~footnotehyper~package }
  {
    Footnote~forbidden.\\
    You~can't~use~the~option~'footnote'~because~the~package~
    footnotehyper~has~already~been~loaded.~
    If~you~want,~you~can~use~the~option~'footnotehyper'~and~the~footnotes~
    within~the~environments~of~piton~will~be~extracted~with~the~tools~
    of~the~package~footnotehyper.\\
    If~you~go~on,~the~package~footnote~won't~be~loaded.
  }
\__piton_msg_new:nn { footnotehyper~with~footnote~package }
  {
    You~can't~use~the~option~'footnotehyper'~because~the~package~
    footnote~has~already~been~loaded.~
    If~you~want,~you~can~use~the~option~'footnote'~and~the~footnotes~
    within~the~environments~of~piton~will~be~extracted~with~the~tools~
    of~the~package~footnote.\\
    If~you~go~on,~the~package~footnotehyper~won't~be~loaded.
  }
\bool_if:NT \g__piton_footnote_bool
  {
    \@ifclassloaded { beamer }
      { \bool_gset_false:N \g__piton_footnote_bool }
      {
        \@ifpackageloaded { footnotehyper }
          { \__piton_error:n { footnote~with~footnotehyper~package } }
          { \usepackage { footnote } }
      }
  }
\bool_if:NT \g__piton_footnotehyper_bool
  {
    \@ifclassloaded { beamer }
      { \bool_gset_false:N \g__piton_footnote_bool }
      {
        \@ifpackageloaded { footnote }
          { \__piton_error:n { footnotehyper~with~footnote~package } }
          { \usepackage { footnotehyper } }
        \bool_gset_true:N \g__piton_footnote_bool
      }
  }
\lua_now:n
  {
    piton = piton~or { }
    piton.ListCommands = lpeg.P ( false )
  }
\str_new:N \l_piton_language_str
\str_set:Nn \l_piton_language_str { python }
\str_new:N \l__piton_path_str
\bool_new:N \l__piton_in_PitonOptions_bool
\bool_new:N \l__piton_in_PitonInputFile_bool
\int_new:N \l__piton_nb_lines_int
\int_new:N \l__piton_nb_non_empty_lines_int
\int_new:N \g__piton_line_int
\tl_new:N \g__piton_aux_tl
\int_new:N \l__piton_splittable_int
\int_set:Nn \l__piton_splittable_int { 100 }
\clist_new:N \l__piton_bg_color_clist
\tl_new:N \l__piton_prompt_bg_color_tl
\str_new:N \l__piton_begin_range_str
\str_new:N \l__piton_end_range_str
\str_new:N \l__piton_file_name_str
\int_new:N \g__piton_env_int
\str_new:N \l__piton_write_str
\seq_new:N \g__piton_write_seq
\bool_new:N \l__piton_show_spaces_bool
\bool_new:N \l__piton_break_lines_in_Piton_bool
\bool_new:N \l__piton_indent_broken_lines_bool
\tl_new:N \l__piton_continuation_symbol_tl
\tl_set:Nn \l__piton_continuation_symbol_tl { + }
\tl_new:N \l__piton_csoi_tl
\tl_set:Nn \l__piton_csoi_tl { $ \hookrightarrow \; $  }
\tl_new:N \l__piton_end_of_broken_line_tl
\tl_set:Nn \l__piton_end_of_broken_line_tl { \hspace*{0.5em} \textbackslash }
\bool_new:N \l__piton_break_lines_in_piton_bool
\dim_new:N \l__piton_width_dim
\dim_new:N \l__piton_line_width_dim
\bool_new:N \l__piton_width_min_bool
\dim_new:N \g__piton_tmp_width_dim
\dim_new:N \l__piton_left_margin_dim
\bool_new:N \l__piton_left_margin_auto_bool
\dim_new:N \l__piton_numbers_sep_dim
\dim_set:Nn \l__piton_numbers_sep_dim { 0.7 em }
\tl_new:N \l__piton_tab_tl
\seq_new:N \g__piton_languages_seq
\cs_new_protected:Npn \__piton_set_tab_tl:n #1
  {
    \tl_clear:N \l__piton_tab_tl
    \prg_replicate:nn { #1 }
      { \tl_put_right:Nn \l__piton_tab_tl { ~ } }
  }
\__piton_set_tab_tl:n { 4 }
\int_new:N \l__piton_gobble_int
\tl_new:N \l__piton_space_tl
\tl_set:Nn \l__piton_space_tl { ~ }
\int_new:N \g__piton_indentation_int
\cs_new_protected:Npn \__piton_an_indentation_space:
  { \int_gincr:N \g__piton_indentation_int }
\cs_new_protected:Npn \__piton_beamer_command:n #1
  {
    \str_set:Nn \l__piton_beamer_command_str { #1 }
    \use:c { #1 }
  }
\cs_new_protected:Npn \__piton_label:n #1
  {
    \bool_if:NTF \l__piton_line_numbers_bool
      {
        \@bsphack
        \protected@write \@auxout { }
          {
            \string \newlabel { #1 }
            {
              { \int_eval:n { \g__piton_visual_line_int + 1 } }
              { \thepage }
            }
          }
        \@esphack
     }
     { \__piton_error:n { label~with~lines~numbers } }
  }
\cs_new_protected:Npn \__piton_marker_beginning:n #1 { }
\cs_new_protected:Npn \__piton_marker_end:n #1 { }
\cs_new_protected:Npn \__piton_open_brace: { \directlua { piton.open_brace() } }
\cs_new_protected:Npn \__piton_close_brace: { \directlua { piton.close_brace() } }
\tl_new:N \g__piton_begin_line_hook_tl
\cs_new_protected:Npn \__piton_prompt:
  {
    \tl_gset:Nn \g__piton_begin_line_hook_tl
      {
        \tl_if_empty:NF \l__piton_prompt_bg_color_tl % added 2023-04-24
          { \clist_set:NV \l__piton_bg_color_clist \l__piton_prompt_bg_color_tl }
      }
  }
\cs_new_protected:Npn \__piton_replace_spaces:n #1
  {
    \tl_set:Nn \l_tmpa_tl { #1 }
    \bool_if:NTF \l__piton_show_spaces_bool
      {
        \tl_set:Nn \l__piton_space_tl { ␣ }
        \regex_replace_all:nnN { \x20 } { ␣ } \l_tmpa_tl % U+2423
      }
      {
        \bool_if:NT \l__piton_break_lines_in_Piton_bool
          {
            \regex_replace_all:nnN
              { \x20 }
              { \c { __piton_breakable_space: } }
              \l_tmpa_tl
          }
      }
    \l_tmpa_tl
  }
\cs_set_protected:Npn \__piton_begin_line: #1 \__piton_end_line:
  {
    \group_begin:
    \g__piton_begin_line_hook_tl
    \int_gzero:N \g__piton_indentation_int
    \bool_if:NTF \l__piton_width_min_bool
      \__piton_put_in_coffin_ii:n
      \__piton_put_in_coffin_i:n
      {
        \language = -1
        \raggedright
        \strut
        \__piton_replace_spaces:n { #1 }
        \strut \hfil
      }
    \hbox_set:Nn \l_tmpa_box
      {
        \skip_horizontal:N \l__piton_left_margin_dim
        \bool_if:NT \l__piton_line_numbers_bool
          {
            \bool_if:nF
              {
                \str_if_eq_p:nn { #1 } { \PitonStyle {Prompt}{} }
                &&
                \l__piton_skip_empty_lines_bool
              }
              { \int_gincr:N \g__piton_visual_line_int}

            \bool_if:nT
              {
                ! \str_if_eq_p:nn { #1 } { \PitonStyle {Prompt}{} }
                ||
                ( ! \l__piton_skip_empty_lines_bool && \l__piton_label_empty_lines_bool )
              }
              \__piton_print_number:

          }
        \clist_if_empty:NF \l__piton_bg_color_clist
          {
            \dim_compare:nNnT \l__piton_left_margin_dim = \c_zero_dim
               { \skip_horizontal:n { 0.5 em } }
          }
        \coffin_typeset:Nnnnn \l_tmpa_coffin T l \c_zero_dim \c_zero_dim
      }
    \box_set_dp:Nn \l_tmpa_box { \box_dp:N \l_tmpa_box + 1.25 pt }
    \box_set_ht:Nn \l_tmpa_box { \box_ht:N \l_tmpa_box + 1.25 pt }
    \clist_if_empty:NTF \l__piton_bg_color_clist
      { \box_use_drop:N \l_tmpa_box }
      {
        \vtop
          {
            \hbox:n
              {
                \__piton_color:N \l__piton_bg_color_clist
                \vrule height \box_ht:N \l_tmpa_box
                       depth \box_dp:N \l_tmpa_box
                       width \l__piton_width_dim
              }
            \skip_vertical:n { - \box_ht_plus_dp:N \l_tmpa_box }
            \box_use_drop:N \l_tmpa_box
          }
      }
    \vspace { - 2.5 pt }
    \group_end:
    \tl_gclear:N \g__piton_begin_line_hook_tl
  }
\cs_set_protected:Npn \__piton_put_in_coffin_i:n
  { \vcoffin_set:Nnn \l_tmpa_coffin \l__piton_line_width_dim }
\cs_set_protected:Npn \__piton_put_in_coffin_ii:n #1
  {
    \hbox_set:Nn \l_tmpa_box { #1 }
    \dim_compare:nNnT { \box_wd:N \l_tmpa_box } > \g__piton_tmp_width_dim
      { \dim_gset:Nn \g__piton_tmp_width_dim { \box_wd:N \l_tmpa_box } }
    \hcoffin_set:Nn \l_tmpa_coffin
      {
        \hbox_to_wd:nn \l__piton_line_width_dim
          { \hbox_unpack:N \l_tmpa_box \hfil }
      }
  }
\cs_set_protected:Npn \__piton_color:N #1
  {
    \int_set:Nn \l_tmpa_int { \clist_count:N #1 }
    \int_set:Nn \l_tmpb_int { \int_mod:nn \g__piton_line_int \l_tmpa_int + 1 }
    \tl_set:Nx \l_tmpa_tl { \clist_item:Nn #1 \l_tmpb_int }
    \tl_if_eq:NnTF \l_tmpa_tl { none }
      { \dim_zero:N \l__piton_width_dim }
      { \exp_args:NV \__piton_color_i:n \l_tmpa_tl }
  }
\cs_set_protected:Npn \__piton_color_i:n #1
  {
    \tl_if_head_eq_meaning:nNTF { #1 } [
      {
        \tl_set:Nn \l_tmpa_tl { #1 }
        \tl_set_rescan:Nno \l_tmpa_tl { } \l_tmpa_tl
        \exp_last_unbraced:No \color \l_tmpa_tl
      }
      { \color { #1 } }
  }
\cs_new_protected:Npn \__piton_newline:
  {
    \int_gincr:N \g__piton_line_int
    \int_compare:nNnT \g__piton_line_int > { \l__piton_splittable_int - 1 }
      {
        \int_compare:nNnT
          { \l__piton_nb_lines_int - \g__piton_line_int } > \l__piton_splittable_int
          {
            \egroup
            \bool_if:NT \g__piton_footnote_bool { \end { savenotes } }
            \par \mode_leave_vertical:
            \bool_if:NT \g__piton_footnote_bool { \begin { savenotes } }
            \vtop \bgroup
          }
     }
  }
\cs_set_protected:Npn \__piton_breakable_space:
  {
    \discretionary
      { \hbox:n { \color { gray } \l__piton_end_of_broken_line_tl } }
      {
        \hbox_overlap_left:n
          {
            {
              \normalfont \footnotesize \color { gray }
              \l__piton_continuation_symbol_tl
            }
            \skip_horizontal:n { 0.3 em }
            \clist_if_empty:NF \l__piton_bg_color_clist
              { \skip_horizontal:n { 0.5 em } }
          }
        \bool_if:NT \l__piton_indent_broken_lines_bool
          {
            \hbox:n
              {
                \prg_replicate:nn { \g__piton_indentation_int } { ~ }
                { \color { gray } \l__piton_csoi_tl }
              }
          }
      }
      { \hbox { ~ } }
  }
\bool_new:N \l__piton_line_numbers_bool
\bool_new:N \l__piton_skip_empty_lines_bool
\bool_set_true:N \l__piton_skip_empty_lines_bool
\bool_new:N \l__piton_line_numbers_absolute_bool
\bool_new:N \l__piton_label_empty_lines_bool
\bool_set_true:N \l__piton_label_empty_lines_bool
\int_new:N \l__piton_number_lines_start_int
\bool_new:N \l__piton_resume_bool
\keys_define:nn { PitonOptions / marker }
  {
    beginning .code:n = \cs_set:Nn \__piton_marker_beginning:n { #1 } ,
    beginning .value_required:n = true ,
    end .code:n = \cs_set:Nn \__piton_marker_end:n { #1 } ,
    end .value_required:n = true ,
    include-lines .bool_set:N = \l__piton_marker_include_lines_bool ,
    include-lines .default:n = true ,
    unknown .code:n = \__piton_error:n { Unknown~key~for~marker }
  }
\keys_define:nn { PitonOptions / line-numbers }
  {
    true .code:n = \bool_set_true:N \l__piton_line_numbers_bool ,
    false .code:n = \bool_set_false:N \l__piton_line_numbers_bool ,

    start .code:n =
      \bool_if:NTF \l__piton_in_PitonOptions_bool
        { Invalid~key }
        {
          \bool_set_true:N \l__piton_line_numbers_bool
          \int_set:Nn \l__piton_number_lines_start_int { #1 }
        } ,
    start .value_required:n = true ,

    skip-empty-lines .code:n =
      \bool_if:NF \l__piton_in_PitonOptions_bool
        { \bool_set_true:N \l__piton_line_numbers_bool }
      \str_if_eq:nnTF { #1 } { false }
        { \bool_set_false:N \l__piton_skip_empty_lines_bool }
        { \bool_set_true:N \l__piton_skip_empty_lines_bool } ,
    skip-empty-lines .default:n = true ,

    label-empty-lines .code:n =
      \bool_if:NF \l__piton_in_PitonOptions_bool
        { \bool_set_true:N \l__piton_line_numbers_bool }
      \str_if_eq:nnTF { #1 } { false }
        { \bool_set_false:N \l__piton_label_empty_lines_bool }
        { \bool_set_true:N \l__piton_label_empty_lines_bool } ,
    label-empty-lines .default:n = true ,

    absolute .code:n =
      \bool_if:NTF \l__piton_in_PitonOptions_bool
        { \bool_set_true:N \l__piton_line_numbers_absolute_bool }
        { \bool_set_true:N \l__piton_line_numbers_bool }
      \bool_if:NT \l__piton_in_PitonInputFile_bool
        {
          \bool_set_true:N \l__piton_line_numbers_absolute_bool
          \bool_set_false:N \l__piton_skip_empty_lines_bool
        }
      \bool_lazy_or:nnF
        \l__piton_in_PitonInputFile_bool
        \l__piton_in_PitonOptions_bool
        { \__piton_error:n { Invalid~key } } ,
    absolute .value_forbidden:n = true ,

    resume .code:n =
      \bool_set_true:N \l__piton_resume_bool
      \bool_if:NF \l__piton_in_PitonOptions_bool
        { \bool_set_true:N \l__piton_line_numbers_bool } ,
    resume .value_forbidden:n = true ,

    sep .dim_set:N = \l__piton_numbers_sep_dim ,
    sep .value_required:n = true ,

    unknown .code:n = \__piton_error:n { Unknown~key~for~line-numbers }
  }
\keys_define:nn { PitonOptions }
  {
    detected-commands .code:n =  \__piton_detected_commands:n { #1 } ,
    detected-commands .value_required:n = true ,
    detected-commands .usage:n = preamble ,
    begin-escape .code:n =
      \lua_now:e { piton.begin_escape = "\lua_escape:n{#1}" } ,
    begin-escape .value_required:n = true ,
    begin-escape .usage:n = preamble ,

    end-escape   .code:n =
      \lua_now:e { piton.end_escape = "\lua_escape:n{#1}" } ,
    end-escape   .value_required:n = true ,
    end-escape .usage:n = preamble ,

    begin-escape-math .code:n =
      \lua_now:e { piton.begin_escape_math = "\lua_escape:n{#1}" } ,
    begin-escape-math .value_required:n = true ,
    begin-escape-math .usage:n = preamble ,

    end-escape-math .code:n =
      \lua_now:e { piton.end_escape_math = "\lua_escape:n{#1}" } ,
    end-escape-math .value_required:n = true ,
    end-escape-math .usage:n = preamble ,

    comment-latex .code:n = \lua_now:n { comment_latex = "#1" } ,
    comment-latex .value_required:n = true ,
    comment-latex .usage:n = preamble ,

    math-comments .bool_set:N = \g__piton_math_comments_bool ,
    math-comments .default:n  = true ,
    math-comments .usage:n = preamble ,
    language         .code:n =
      \str_set:Nx \l_piton_language_str { \str_lowercase:n { #1 } } ,
    language         .value_required:n  = true ,
    path             .str_set:N         = \l__piton_path_str ,
    path             .value_required:n  = true ,
    gobble           .int_set:N         = \l__piton_gobble_int ,
    gobble           .value_required:n  = true ,
    auto-gobble      .code:n            = \int_set:Nn \l__piton_gobble_int { -1 } ,
    auto-gobble      .value_forbidden:n = true ,
    env-gobble       .code:n            = \int_set:Nn \l__piton_gobble_int { -2 } ,
    env-gobble       .value_forbidden:n = true ,
    tabs-auto-gobble .code:n            = \int_set:Nn \l__piton_gobble_int { -3 } ,
    tabs-auto-gobble .value_forbidden:n = true ,

    marker .code:n =
      \bool_lazy_or:nnTF
        \l__piton_in_PitonInputFile_bool
        \l__piton_in_PitonOptions_bool
        { \keys_set:nn { PitonOptions / marker } { #1 } }
        { \__piton_error:n { Invalid~key } } ,
    marker .value_required:n = true ,

    line-numbers .code:n =
      \keys_set:nn { PitonOptions / line-numbers } { #1 } ,
    line-numbers .default:n = true ,

    splittable       .int_set:N         = \l__piton_splittable_int ,
    splittable       .default:n         = 1 ,
    background-color .clist_set:N       = \l__piton_bg_color_clist ,
    background-color .value_required:n  = true ,
    prompt-background-color .tl_set:N         = \l__piton_prompt_bg_color_tl ,
    prompt-background-color .value_required:n = true ,

    width .code:n =
      \str_if_eq:nnTF  { #1 } { min }
        {
          \bool_set_true:N \l__piton_width_min_bool
          \dim_zero:N \l__piton_width_dim
        }
        {
          \bool_set_false:N \l__piton_width_min_bool
          \dim_set:Nn \l__piton_width_dim { #1 }
        } ,
    width .value_required:n  = true ,

    write .str_set:N = \l__piton_write_str ,
    write .value_required:n = true ,

    left-margin      .code:n =
      \str_if_eq:nnTF { #1 } { auto }
        {
          \dim_zero:N \l__piton_left_margin_dim
          \bool_set_true:N \l__piton_left_margin_auto_bool
        }
        {
          \dim_set:Nn \l__piton_left_margin_dim { #1 }
          \bool_set_false:N \l__piton_left_margin_auto_bool
        } ,
    left-margin      .value_required:n  = true ,

    tab-size         .code:n            = \__piton_set_tab_tl:n { #1 } ,
    tab-size         .value_required:n  = true ,
    show-spaces      .bool_set:N        = \l__piton_show_spaces_bool ,
    show-spaces      .default:n         = true ,
    show-spaces-in-strings .code:n      = \tl_set:Nn \l__piton_space_tl { ␣ } , % U+2423
    show-spaces-in-strings .value_forbidden:n = true ,
    break-lines-in-Piton .bool_set:N    = \l__piton_break_lines_in_Piton_bool ,
    break-lines-in-Piton .default:n     = true ,
    break-lines-in-piton .bool_set:N    = \l__piton_break_lines_in_piton_bool ,
    break-lines-in-piton .default:n     = true ,
    break-lines .meta:n = { break-lines-in-piton , break-lines-in-Piton } ,
    break-lines .value_forbidden:n      = true ,
    indent-broken-lines .bool_set:N     = \l__piton_indent_broken_lines_bool ,
    indent-broken-lines .default:n      = true ,
    end-of-broken-line  .tl_set:N       = \l__piton_end_of_broken_line_tl ,
    end-of-broken-line  .value_required:n = true ,
    continuation-symbol .tl_set:N       = \l__piton_continuation_symbol_tl ,
    continuation-symbol .value_required:n = true ,
    continuation-symbol-on-indentation .tl_set:N = \l__piton_csoi_tl ,
    continuation-symbol-on-indentation .value_required:n = true ,

    first-line .code:n = \__piton_in_PitonInputFile:n
      { \int_set:Nn \l__piton_first_line_int { #1 } } ,
    first-line .value_required:n = true ,

    last-line .code:n = \__piton_in_PitonInputFile:n
      { \int_set:Nn \l__piton_last_line_int { #1 } } ,
    last-line .value_required:n = true ,

    begin-range .code:n = \__piton_in_PitonInputFile:n
      { \str_set:Nn \l__piton_begin_range_str { #1 } } ,
    begin-range .value_required:n = true ,

    end-range .code:n = \__piton_in_PitonInputFile:n
      { \str_set:Nn \l__piton_end_range_str { #1 } } ,
    end-range .value_required:n = true ,

    range .code:n = \__piton_in_PitonInputFile:n
      {
        \str_set:Nn \l__piton_begin_range_str { #1 }
        \str_set:Nn \l__piton_end_range_str { #1 }
      } ,
    range .value_required:n = true ,

    resume .meta:n = line-numbers/resume ,

    unknown .code:n = \__piton_error:n { Unknown~key~for~PitonOptions } ,

    % deprecated
    all-line-numbers .code:n =
      \bool_set_true:N \l__piton_line_numbers_bool
      \bool_set_false:N \l__piton_skip_empty_lines_bool ,
    all-line-numbers .value_forbidden:n = true ,

    % deprecated
    numbers-sep .dim_set:N = \l__piton_numbers_sep_dim ,
    numbers-sep .value_required:n = true
  }
\cs_new_protected:Npn \__piton_in_PitonInputFile:n #1
  {
    \bool_if:NTF \l__piton_in_PitonInputFile_bool
      { #1 }
      { \__piton_error:n { Invalid~key } }
  }
\NewDocumentCommand \PitonOptions { m }
  {
    \bool_set_true:N \l__piton_in_PitonOptions_bool
    \keys_set:nn { PitonOptions } { #1 }
    \bool_set_false:N \l__piton_in_PitonOptions_bool
  }
\NewDocumentCommand \__piton_fake_PitonOptions { }
  { \keys_set:nn { PitonOptions } }
\int_new:N \g__piton_visual_line_int
\cs_new_protected:Npn \__piton_print_number:
  {
    \hbox_overlap_left:n
      {
        {
          \color { gray }
          \footnotesize
          \int_to_arabic:n \g__piton_visual_line_int
        }
        \skip_horizontal:N \l__piton_numbers_sep_dim
      }
  }
\cs_new_protected:Npn \__piton_write_aux:
  {
    \tl_if_empty:NF \g__piton_aux_tl
      {
        \iow_now:Nn \@mainaux { \ExplSyntaxOn }
        \iow_now:Nx \@mainaux
          {
            \tl_gset:cn { c__piton_ \int_use:N \g__piton_env_int _ tl }
              { \exp_not:o \g__piton_aux_tl }
          }
        \iow_now:Nn \@mainaux { \ExplSyntaxOff }
      }
    \tl_gclear:N \g__piton_aux_tl
  }
\cs_new_protected:Npn \__piton_width_to_aux:
  {
    \tl_gput_right:Nx \g__piton_aux_tl
      {
        \dim_set:Nn \l__piton_line_width_dim
          { \dim_eval:n { \g__piton_tmp_width_dim } }
      }
  }
\NewDocumentCommand { \piton } { }
  { \peek_meaning:NTF \bgroup \__piton_piton_standard \__piton_piton_verbatim }
\NewDocumentCommand { \__piton_piton_standard } { m }
  {
    \group_begin:
    \ttfamily
    \automatichyphenmode = 1
    \cs_set_eq:NN \\ \c_backslash_str
    \cs_set_eq:NN \% \c_percent_str
    \cs_set_eq:NN \{ \c_left_brace_str
    \cs_set_eq:NN \} \c_right_brace_str
    \cs_set_eq:NN \$ \c_dollar_str
    \cs_set_eq:cN { ~ } \space
    \cs_set_protected:Npn \__piton_begin_line: { }
    \cs_set_protected:Npn \__piton_end_line: { }
    \tl_set:Nx \l_tmpa_tl
      {
        \lua_now:e
          { piton.ParseBis('\l_piton_language_str',token.scan_string()) }
          { #1 }
      }
    \bool_if:NTF \l__piton_show_spaces_bool
      { \regex_replace_all:nnN { \x20 } { ␣ } \l_tmpa_tl } % U+2423
      {
        \bool_if:NT \l__piton_break_lines_in_piton_bool
          { \regex_replace_all:nnN { \x20 } { \x20 } \l_tmpa_tl }
      }
    \l_tmpa_tl
    \group_end:
  }
\NewDocumentCommand { \__piton_piton_verbatim } { v }
  {
    \group_begin:
    \ttfamily
    \automatichyphenmode = 1
    \cs_set_protected:Npn \__piton_begin_line: { }
    \cs_set_protected:Npn \__piton_end_line: { }
    \tl_set:Nx \l_tmpa_tl
      {
        \lua_now:e
          { piton.Parse('\l_piton_language_str',token.scan_string()) }
          { #1 }
      }
    \bool_if:NT \l__piton_show_spaces_bool
      { \regex_replace_all:nnN { \x20 } { ␣ } \l_tmpa_tl } % U+2423
    \l_tmpa_tl
    \group_end:
  }

\cs_new_protected:Npn \__piton_piton:n #1
  {
    \group_begin:
    \cs_set_protected:Npn \__piton_begin_line: { }
    \cs_set_protected:Npn \__piton_end_line: { }
    \bool_lazy_or:nnTF
      \l__piton_break_lines_in_piton_bool
      \l__piton_break_lines_in_Piton_bool
      {
        \tl_set:Nx \l_tmpa_tl
          {
            \lua_now:e
              { piton.ParseTer('\l_piton_language_str',token.scan_string()) }
              { #1 }
          }
      }
      {
        \tl_set:Nx \l_tmpa_tl
          {
            \lua_now:e
              { piton.Parse('\l_piton_language_str',token.scan_string()) }
              { #1 }
          }
      }
    \bool_if:NT \l__piton_show_spaces_bool
      { \regex_replace_all:nnN { \x20 } { ␣ } \l_tmpa_tl } % U+2423
    \l_tmpa_tl
    \group_end:
  }
\cs_new_protected:Npn \__piton_piton_no_cr:n #1
  {
    \group_begin:
    \cs_set_protected:Npn \__piton_begin_line: { }
    \cs_set_protected:Npn \__piton_end_line: { }
    \cs_set_protected:Npn \__piton_newline:
      { \msg_fatal:nn { piton } { cr~not~allowed } }
    \bool_lazy_or:nnTF
      \l__piton_break_lines_in_piton_bool
      \l__piton_break_lines_in_Piton_bool
      {
        \tl_set:Nx \l_tmpa_tl
          {
            \lua_now:e
              { piton.ParseTer('\l_piton_language_str',token.scan_string()) }
              { #1 }
          }
      }
      {
        \tl_set:Nx \l_tmpa_tl
          {
            \lua_now:e
              { piton.Parse('\l_piton_language_str',token.scan_string()) }
              { #1 }
          }
      }
    \bool_if:NT \l__piton_show_spaces_bool
      { \regex_replace_all:nnN { \x20 } { ␣ } \l_tmpa_tl } % U+2423
    \l_tmpa_tl
    \group_end:
  }
\cs_new:Npn \__piton_pre_env:
  {
    \automatichyphenmode = 1
    \int_gincr:N \g__piton_env_int
    \tl_gclear:N \g__piton_aux_tl
    \dim_compare:nNnT \l__piton_width_dim = \c_zero_dim
      { \dim_set_eq:NN \l__piton_width_dim \linewidth }
    \cs_if_exist_use:c { c__piton _ \int_use:N \g__piton_env_int _ tl }
    \bool_if:NF \l__piton_resume_bool { \int_gzero:N \g__piton_visual_line_int }
    \dim_gzero:N \g__piton_tmp_width_dim
    \int_gzero:N \g__piton_line_int
    \dim_zero:N \parindent
    \dim_zero:N \lineskip
    \cs_set_eq:NN \label \__piton_label:n
  }
\cs_new_protected:Npn \__piton_compute_left_margin:nn #1 #2
  {
    \bool_lazy_and:nnT \l__piton_left_margin_auto_bool \l__piton_line_numbers_bool
       {
        \hbox_set:Nn \l_tmpa_box
          {
            \footnotesize
            \bool_if:NTF \l__piton_skip_empty_lines_bool
              {
                \lua_now:n
                  { piton.#1(token.scan_argument()) }
                  { #2 }
                \int_to_arabic:n
                  { \g__piton_visual_line_int + \l__piton_nb_non_empty_lines_int }
               }
              {
                \int_to_arabic:n
                  { \g__piton_visual_line_int + \l__piton_nb_lines_int }
              }
           }
         \dim_set:Nn \l__piton_left_margin_dim
           { \box_wd:N \l_tmpa_box + \l__piton_numbers_sep_dim + 0.1 em }
       }
  }
\cs_generate_variant:Nn \__piton_compute_left_margin:nn { n o }
\cs_new_protected:Npn \__piton_compute_width:
  {
    \dim_compare:nNnTF \l__piton_line_width_dim = \c_zero_dim
      {
        \dim_set_eq:NN \l__piton_line_width_dim \l__piton_width_dim
        \clist_if_empty:NTF \l__piton_bg_color_clist
          { \dim_sub:Nn \l__piton_line_width_dim \l__piton_left_margin_dim }
          {
            \dim_sub:Nn \l__piton_line_width_dim { 0.5 em }
            \dim_compare:nNnTF \l__piton_left_margin_dim = \c_zero_dim
              { \dim_sub:Nn \l__piton_line_width_dim { 0.5 em } }
              { \dim_sub:Nn \l__piton_line_width_dim \l__piton_left_margin_dim }
          }
      }
      {
        \dim_set_eq:NN \l__piton_width_dim \l__piton_line_width_dim
        \clist_if_empty:NTF \l__piton_bg_color_clist
          { \dim_add:Nn \l__piton_width_dim \l__piton_left_margin_dim }
          {
            \dim_add:Nn \l__piton_width_dim { 0.5 em }
            \dim_compare:nNnTF \l__piton_left_margin_dim = \c_zero_dim
              { \dim_add:Nn \l__piton_width_dim { 0.5 em } }
              { \dim_add:Nn \l__piton_width_dim \l__piton_left_margin_dim }
          }
      }
  }
\NewDocumentCommand { \NewPitonEnvironment } { m m m m }
  {
    \use:x
      {
        \cs_set_protected:Npn
          \use:c { __piton_collect_ #1 :w }
          ####1
          \c_backslash_str end \c_left_brace_str #1 \c_right_brace_str
      }
         {
            \group_end:
            \mode_if_vertical:TF \mode_leave_vertical: \newline
            \lua_now:n { piton.CountLines(token.scan_argument()) } { ##1 }
            \__piton_compute_left_margin:nn { CountNonEmptyLines } { ##1 }
            \__piton_compute_width:
            \ttfamily
            \dim_zero:N \parskip
            \bool_if:NT \g__piton_footnote_bool { \begin { savenotes } }
            \lua_now:e { piton.write = "\l__piton_write_str" }
            \str_if_empty:NF \l__piton_write_str
              {
                \seq_if_in:NVTF \g__piton_write_seq \l__piton_write_str
                  { \lua_now:n { piton.write_mode = "a" } }
                  {
                    \lua_now:n { piton.write_mode = "w" }
                    \seq_gput_left:NV \g__piton_write_seq \l__piton_write_str
                  }
              }
            \vtop \bgroup
            \lua_now:e
              {
                piton.GobbleParse
                  (
                    '\l_piton_language_str' ,
                    \int_use:N \l__piton_gobble_int ,
                    token.scan_argument()
                  )
              }
              { ##1 }
            \vspace { 2.5 pt }
            \egroup
            \bool_if:NT \g__piton_footnote_bool { \end { savenotes } }
            \bool_if:NT \l__piton_width_min_bool \__piton_width_to_aux:
            \end { #1 }
            \__piton_write_aux:
          }
    \NewDocumentEnvironment { #1 } { #2 }
      {
        \cs_set_eq:NN \PitonOptions \__piton_fake_PitonOptions
        #3
        \__piton_pre_env:
        \int_compare:nNnT \l__piton_number_lines_start_int > \c_zero_int
          { \int_gset:Nn \g__piton_visual_line_int { \l__piton_number_lines_start_int - 1 } }
        \group_begin:
        \tl_map_function:nN
          { \ \\ \{ \} \$ \& \# \^ \_ \% \~ \^^I }
          \char_set_catcode_other:N
        \use:c { __piton_collect_ #1 :w }
      }
      { #4 }
    \AddToHook { env / #1 / begin } { \char_set_catcode_other:N \^^M }
  }
\bool_if:NTF \g__piton_beamer_bool
  {
    \NewPitonEnvironment { Piton } { d < > O { } }
      {
        \keys_set:nn { PitonOptions } { #2 }
        \IfValueTF { #1 }
          { \begin { uncoverenv } < #1 > }
          { \begin { uncoverenv } }
      }
      { \end { uncoverenv } }
  }
  {
    \NewPitonEnvironment { Piton } { O { } }
      { \keys_set:nn { PitonOptions } { #1 } }
      { }
  }
\NewDocumentCommand { \PitonInputFile } { d < > O { } m }
  {
    \group_begin:
    \tl_if_empty:NTF \l__piton_path_str
      { \str_set:Nn \l__piton_file_name_str { #3 } }
      {
        \str_set_eq:NN \l__piton_file_name_str \l__piton_path_str
        \str_put_right:Nn \l__piton_file_name_str { / #3 }
      }
    \file_if_exist:nTF { \l__piton_file_name_str }
      { \__piton_input_file:nn { #1 } { #2 } }
      { \msg_error:nnn { piton } { Unknown~file } { #3 } }
    \group_end:
  }
\cs_new_protected:Npn \__piton_input_file:nn #1 #2
  {
    \tl_if_novalue:nF { #1 }
      {
        \bool_if:NTF \g__piton_beamer_bool
          { \begin { uncoverenv } < #1 > }
          { \__piton_error:n { overlay~without~beamer } }
      }
    \group_begin:
      \int_zero_new:N \l__piton_first_line_int
      \int_zero_new:N \l__piton_last_line_int
      \int_set_eq:NN \l__piton_last_line_int \c_max_int
      \bool_set_true:N \l__piton_in_PitonInputFile_bool
      \keys_set:nn { PitonOptions } { #2 }
      \bool_if:NT \l__piton_line_numbers_absolute_bool
        { \bool_set_false:N \l__piton_skip_empty_lines_bool }
      \bool_if:nTF
        {
          (
            \int_compare_p:nNn \l__piton_first_line_int > \c_zero_int
            || \int_compare_p:nNn \l__piton_last_line_int < \c_max_int
          )
          && ! \str_if_empty_p:N \l__piton_begin_range_str
        }
        {
          \__piton_error:n { bad~range~specification }
          \int_zero:N \l__piton_first_line_int
          \int_set_eq:NN \l__piton_last_line_int \c_max_int
        }
        {
          \str_if_empty:NF \l__piton_begin_range_str
            {
              \__piton_compute_range:
              \bool_lazy_or:nnT
                \l__piton_marker_include_lines_bool
                { ! \str_if_eq_p:NN \l__piton_begin_range_str \l__piton_end_range_str }
                {
                  \int_decr:N \l__piton_first_line_int
                  \int_incr:N \l__piton_last_line_int
                }
            }
        }
      \__piton_pre_env:
      \bool_if:NT \l__piton_line_numbers_absolute_bool
        { \int_gset:Nn \g__piton_visual_line_int { \l__piton_first_line_int - 1 } }
      \int_compare:nNnT \l__piton_number_lines_start_int > \c_zero_int
        {
          \int_gset:Nn \g__piton_visual_line_int
            { \l__piton_number_lines_start_int - 1 }
        }
      \int_compare:nNnT \g__piton_visual_line_int < \c_zero_int
        { \int_gzero:N \g__piton_visual_line_int }
      \mode_if_vertical:TF \mode_leave_vertical: \newline
      \lua_now:e { piton.CountLinesFile('\l__piton_file_name_str') }
      \__piton_compute_left_margin:no { CountNonEmptyLinesFile } \l__piton_file_name_str
      \__piton_compute_width:
      \ttfamily
      \bool_if:NT \g__piton_footnote_bool { \begin { savenotes } }
      \vtop \bgroup
      \lua_now:e
        {
          piton.ParseFile(
           '\l_piton_language_str' ,
           '\l__piton_file_name_str' ,
           \int_use:N \l__piton_first_line_int ,
           \int_use:N \l__piton_last_line_int )
        }
      \egroup
      \bool_if:NT \g__piton_footnote_bool { \end { savenotes } }
      \bool_if:NT \l__piton_width_min_bool \__piton_width_to_aux:
    \group_end:
    \tl_if_novalue:nF { #1 }
      { \bool_if:NT \g__piton_beamer_bool { \end { uncoverenv } } }
    \__piton_write_aux:
  }
\cs_new_protected:Npn \__piton_compute_range:
  {
    \str_set:Nx \l_tmpa_str { \__piton_marker_beginning:n \l__piton_begin_range_str }
    \str_set:Nx \l_tmpb_str { \__piton_marker_end:n \l__piton_end_range_str }
    \exp_args:NnV \regex_replace_all:nnN { \\\# } \c_hash_str \l_tmpa_str
    \exp_args:NnV \regex_replace_all:nnN { \\\# } \c_hash_str \l_tmpb_str
    \lua_now:e
      {
        piton.ComputeRange
          ( '\l_tmpa_str' , '\l_tmpb_str' , '\l__piton_file_name_str' )
      }
  }
\NewDocumentCommand { \PitonStyle } { m }
  {
    \cs_if_exist_use:cF { pitonStyle _ \l_piton_language_str  _ #1 }
      { \use:c { pitonStyle _ #1 } }
  }
\NewDocumentCommand { \SetPitonStyle } { O { } m }
  {
    \str_set:Nx \l__piton_SetPitonStyle_option_str { \str_lowercase:n { #1 } }
    \str_if_eq:onT \l__piton_SetPitonStyle_option_str { current-language }
      { \str_set_eq:NN \l__piton_SetPitonStyle_option_str \l_piton_language_str }
    \keys_set:nn { piton / Styles } { #2 }
    \str_clear:N \l__piton_SetPitonStyle_option_str
  }
\cs_new_protected:Npn \__piton_math_scantokens:n #1
  { \normalfont \scantextokens { $#1$ } }
\clist_new:N \g__piton_style_clist
\clist_set:Nn \g__piton_styles_clist
  {
    Comment ,
    Comment.LaTeX ,
    Exception ,
    FormattingType ,
    Identifier ,
    InitialValues ,
    Interpol.Inside ,
    Keyword ,
    Keyword.Constant ,
    Name.Builtin ,
    Name.Class ,
    Name.Constructor ,
    Name.Decorator ,
    Name.Field ,
    Name.Function ,
    Name.Module ,
    Name.Namespace ,
    Name.Table ,
    Name.Type ,
    Number ,
    Operator ,
    Operator.Word ,
    Preproc ,
    Prompt ,
    String.Doc ,
    String.Interpol ,
    String.Long ,
    String.Short ,
    TypeParameter ,
    UserFunction
  }

\clist_map_inline:Nn \g__piton_styles_clist
  {
    \keys_define:nn { piton / Styles }
      {
        #1 .value_required:n = true ,
        #1 .code:n =
         \tl_set:cn
           {
             pitonStyle _
             \str_if_empty:NF \l__piton_SetPitonStyle_option_str
               { \l__piton_SetPitonStyle_option_str _ }
             #1
           }
           { ##1 }
      }
  }

\keys_define:nn { piton / Styles }
  {
    String          .meta:n = { String.Long = #1 , String.Short = #1 } ,
    Comment.Math    .tl_set:c = pitonStyle Comment.Math ,
    Comment.Math    .default:n = \__piton_math_scantokens:n ,
    Comment.Math    .initial:n = ,
    ParseAgain      .tl_set:c = pitonStyle ParseAgain ,
    ParseAgain      .value_required:n = true ,
    ParseAgain.noCR .tl_set:c = pitonStyle ParseAgain.noCR ,
    ParseAgain.noCR .value_required:n = true ,
    unknown         .code:n =
      \__piton_error:n { Unknown~key~for~SetPitonStyle }
  }
\clist_gput_left:Nn \g__piton_styles_clist { String }
\clist_gsort:Nn \g__piton_styles_clist
  {
    \str_compare:nNnTF { #1 } < { #2 }
      \sort_return_same:
      \sort_return_swapped:
  }
\SetPitonStyle
  {
    Comment            = \color[HTML]{0099FF} \itshape ,
    Exception          = \color[HTML]{CC0000} ,
    Keyword            = \color[HTML]{006699} \bfseries ,
    Keyword.Constant   = \color[HTML]{006699} \bfseries ,
    Name.Builtin       = \color[HTML]{336666} ,
    Name.Decorator     = \color[HTML]{9999FF},
    Name.Class         = \color[HTML]{00AA88} \bfseries ,
    Name.Function      = \color[HTML]{CC00FF} ,
    Name.Namespace     = \color[HTML]{00CCFF} ,
    Name.Constructor   = \color[HTML]{006000} \bfseries ,
    Name.Field         = \color[HTML]{AA6600} ,
    Name.Module        = \color[HTML]{0060A0} \bfseries ,
    Name.Table         = \color[HTML]{309030} ,
    Number             = \color[HTML]{FF6600} ,
    Operator           = \color[HTML]{555555} ,
    Operator.Word      = \bfseries ,
    String             = \color[HTML]{CC3300} ,
    String.Doc         = \color[HTML]{CC3300} \itshape ,
    String.Interpol    = \color[HTML]{AA0000} ,
    Comment.LaTeX      = \normalfont \color[rgb]{.468,.532,.6} ,
    Name.Type          = \color[HTML]{336666} ,
    InitialValues      = \__piton_piton:n ,
    Interpol.Inside    = \color{black}\__piton_piton:n ,
    TypeParameter      = \color[HTML]{336666} \itshape ,
    Preproc            = \color[HTML]{AA6600} \slshape ,
    Identifier         = \__piton_identifier:n ,
    UserFunction       = ,
    Prompt             = ,
    ParseAgain.noCR    = \__piton_piton_no_cr:n ,
    ParseAgain         = \__piton_piton:n ,
  }
\bool_if:NT \g__piton_math_comments_bool { \SetPitonStyle { Comment.Math } }
\NewDocumentCommand { \SetPitonIdentifier } { o m m }
  {
    \clist_set:Nn \l_tmpa_clist { #2 }
    \IfNoValueTF { #1 }
      {
        \clist_map_inline:Nn \l_tmpa_clist
          { \cs_set:cpn { pitonIdentifier _ ##1 } { #3 } }
      }
      {
        \str_set:Nx \l_tmpa_str { \str_lowercase:n { #1 } }
        \str_if_eq:onT \l_tmpa_str { current-language }
          { \str_set_eq:NN \l_tmpa_str \l_piton_language_str }
        \clist_map_inline:Nn \l_tmpa_clist
          { \cs_set:cpn { pitonIdentifier _ \l_tmpa_str _ ##1 } { #3 } }
      }
  }
\cs_new_protected:Npn \__piton_identifier:n #1
  {
    \cs_if_exist_use:cF { pitonIdentifier _ \l_piton_language_str _ #1 }
      { \cs_if_exist_use:c { pitonIdentifier_ #1 } }
    { #1 }
  }
\keys_define:nn { PitonOptions }
  { identifiers .code:n = \__piton_set_identifiers:n { #1 } }
\keys_define:nn { Piton / identifiers }
  {
    names .clist_set:N = \l__piton_identifiers_names_tl ,
    style .tl_set:N    = \l__piton_style_tl ,
  }
\cs_new_protected:Npn \__piton_set_identifiers:n #1
  {
    \__piton_error:n { key~identifiers~deprecated }
    \__piton_gredirect_none:n { key~identifiers~deprecated }
    \clist_clear_new:N \l__piton_identifiers_names_tl
    \tl_clear_new:N \l__piton_style_tl
    \keys_set:nn { Piton / identifiers } { #1 }
    \clist_map_inline:Nn \l__piton_identifiers_names_tl
      {
        \tl_set_eq:cN
          { PitonIdentifier _ \l_piton_language_str _ ##1 }
          \l__piton_style_tl
      }
  }
\cs_new_protected:cpn { pitonStyle _ Name.Function.Internal } #1
  {
    { \PitonStyle { Name.Function } { #1 } }
    \cs_gset_protected:cpn { PitonIdentifier _ \l_piton_language_str _ #1 }
      { \PitonStyle { UserFunction } }
    \seq_if_exist:cF { g__piton_functions _ \l_piton_language_str _ seq }
      { \seq_new:c { g__piton_functions _ \l_piton_language_str _ seq } }
    \seq_gput_right:cn { g__piton_functions _ \l_piton_language_str _ seq } { #1 }
    \seq_if_in:NVF \g__piton_languages_seq \l_piton_language_str
      { \seq_gput_left:NV \g__piton_languages_seq \l_piton_language_str }
  }
\NewDocumentCommand \PitonClearUserFunctions { ! o }
  {
    \tl_if_novalue:nTF { #1 }
      { \__piton_clear_all_functions: }
      { \__piton_clear_list_functions:n { #1 } }
  }
\cs_new_protected:Npn \__piton_clear_list_functions:n #1
  {
    \clist_set:Nn \l_tmpa_clist { #1 }
    \clist_map_function:NN \l_tmpa_clist \__piton_clear_functions_i:n
    \clist_map_inline:nn { #1 }
      { \seq_gremove_all:Nn \g__piton_languages_seq { ##1 } }
  }
\cs_new_protected:Npn \__piton_clear_functions_i:n #1
  { \exp_args:Ne \__piton_clear_functions_ii:n { \str_lowercase:n { #1 } } }
\cs_new_protected:Npn \__piton_clear_functions_ii:n #1
  {
    \seq_if_exist:cT { g__piton_functions _ #1 _ seq }
      {
        \seq_map_inline:cn { g__piton_functions _ #1 _ seq }
          { \cs_undefine:c { PitonIdentifier _ #1 _ ##1} }
        \seq_gclear:c { g__piton_functions _ #1 _ seq }
      }
  }
\cs_new_protected:Npn \__piton_clear_functions:n #1
  {
    \__piton_clear_functions_i:n { #1 }
    \seq_gremove_all:Nn \g__piton_languages_seq { #1 }
  }
\cs_new_protected:Npn \__piton_clear_all_functions:
  {
    \seq_map_function:NN \g__piton_languages_seq \__piton_clear_functions_i:n
    \seq_gclear:N \g__piton_languages_seq
  }
\AddToHook { env / piton / begin }
  { \msg_fatal:nn { piton } { No~environment~piton } }

\msg_new:nnn { piton } { No~environment~piton }
  {
    There~is~no~environment~piton!\\
    There~is~an~environment~{Piton}~and~a~command~
    \token_to_str:N \piton\ but~there~is~no~environment~
    {piton}.~This~error~is~fatal.
  }
\__piton_msg_new:nn { key~identifiers~deprecated }
  {
    The~key~'identifiers'~in~the~command~\token_to_str:N PitonOptions\
    is~now~deprecated:~you~should~use~the~command~
    \token_to_str:N \SetPitonIdentifier\ instead.\\
    However,~you~can~go~on.
  }
\__piton_msg_new:nn { Unknown~key~for~SetPitonStyle }
  {
    The~style~'\l_keys_key_str'~is~unknown.\\
    This~key~will~be~ignored.\\
    The~available~styles~are~(in~alphabetic~order):~
    \clist_use:Nnnn \g__piton_styles_clist { ~and~ } { ,~ } { ~and~ }.
  }
\__piton_msg_new:nn { Invalid~key }
  {
    Wrong~use~of~key.\\
    You~can't~use~the~key~'\l_keys_key_str'~here.\\
    That~key~will~be~ignored.
  }
\__piton_msg_new:nn { Unknown~key~for~line-numbers }
  {
    Unknown~key. \\
    The~key~'line-numbers / \l_keys_key_str'~is~unknown.\\
    The~available~keys~of~the~family~'line-numbers'~are~(in~
    alphabetic~order):~
    absolute,~false,~label-empty-lines,~resume,~skip-empty-lines,~
    sep,~start~and~true.\\
    That~key~will~be~ignored.
  }
\__piton_msg_new:nn { Unknown~key~for~marker }
  {
    Unknown~key. \\
    The~key~'marker / \l_keys_key_str'~is~unknown.\\
    The~available~keys~of~the~family~'marker'~are~(in~
    alphabetic~order):~ beginning,~end~and~include-lines.\\
    That~key~will~be~ignored.
  }
\__piton_msg_new:nn { bad~range~specification }
  {
    Incompatible~keys.\\
    You~can't~specify~the~range~of~lines~to~include~by~using~both~
    markers~and~explicit~number~of~lines.\\
    Your~whole~file~'\l__piton_file_name_str'~will~be~included.
  }
\__piton_msg_new:nn { syntax~error }
  {
    Your~code~\l_piton_language_str\ is~not~syntactically~correct.\\
    It~won't~be~printed~in~the~PDF~file.
  }
\NewDocumentCommand \PitonSyntaxError { }
  { \__piton_error:n { syntax~error } }
\__piton_msg_new:nn { begin~marker~not~found }
  {
    Marker~not~found.\\
    The~range~'\l__piton_begin_range_str'~provided~to~the~
    command~\token_to_str:N \PitonInputFile\ has~not~been~found.~
    The~whole~file~'\l__piton_file_name_str'~will~be~inserted.
  }
\__piton_msg_new:nn { end~marker~not~found }
  {
    Marker~not~found.\\
    The~marker~of~end~of~the~range~'\l__piton_end_range_str'~
    provided~to~the~command~\token_to_str:N \PitonInputFile\
    has~not~been~found.~The~file~'\l__piton_file_name_str'~will~
    be~inserted~till~the~end.
  }
\NewDocumentCommand \PitonBeginMarkerNotFound { }
  { \__piton_error:n { begin~marker~not~found } }
\NewDocumentCommand \PitonEndMarkerNotFound { }
  { \__piton_error:n { end~marker~not~found } }
\__piton_msg_new:nn { Unknown~file }
  {
    Unknown~file. \\
    The~file~'#1'~is~unknown.\\
    Your~command~\token_to_str:N \PitonInputFile\ will~be~discarded.
  }
\msg_new:nnnn { piton } { Unknown~key~for~PitonOptions }
  {
    Unknown~key. \\
    The~key~'\l_keys_key_str'~is~unknown~for~\token_to_str:N \PitonOptions.~
    It~will~be~ignored.\\
    For~a~list~of~the~available~keys,~type~H~<return>.
  }
  {
    The~available~keys~are~(in~alphabetic~order):~
    auto-gobble,~
    background-color,~
    break-lines,~
    break-lines-in-piton,~
    break-lines-in-Piton,~
    continuation-symbol,~
    continuation-symbol-on-indentation,~
    detected-commands,~
    end-of-broken-line,~
    end-range,~
    env-gobble,~
    gobble,~
    indent-broken-lines,~
    language,~
    left-margin,~
    line-numbers/,~
    marker/,~
    path,~
    prompt-background-color,~
    resume,~
    show-spaces,~
    show-spaces-in-strings,~
    splittable,~
    tabs-auto-gobble,~
    tab-size,~width~
    and~write.
  }
\__piton_msg_new:nn { label~with~lines~numbers }
  {
    You~can't~use~the~command~\token_to_str:N \label\
    because~the~key~'line-numbers'~is~not~active.\\
    If~you~go~on,~that~command~will~ignored.
  }
\__piton_msg_new:nn { cr~not~allowed }
  {
    You~can't~put~any~carriage~return~in~the~argument~
    of~a~command~\c_backslash_str
    \l__piton_beamer_command_str\ within~an~
    environment~of~'piton'.~You~should~consider~using~the~
    corresponding~environment.\\
    That~error~is~fatal.
  }
\__piton_msg_new:nn { overlay~without~beamer }
  {
    You~can't~use~an~argument~<...>~for~your~command~
    \token_to_str:N \PitonInputFile\ because~you~are~not~
    in~Beamer.\\
    If~you~go~on,~that~argument~will~be~ignored.
  }
\hook_gput_code:nnn { begindocument } { . }
  { \lua_now:e { require("piton.lua") } }
\cs_new_protected:Npn \__piton_detected_commands:n #1
  { \lua_now:n { piton.addListCommands('#1') } }
\ExplSyntaxOff
\directlua
  {
    lpeg.locale(lpeg)
    local P , alpha , C , Cf, space = lpeg.P , lpeg.alpha , lpeg.C , lpeg.Cf , lpeg.space
    local One_P = space ^ 0
                  * C ( alpha ^ 1 ) / ( function (s) return P ( string.char(92) .. s ) end )
                  * space ^ 0
    function piton.addListCommands( key_value )
       piton.ListCommands =
         piton.ListCommands +
           Cf ( One_P * ( P "," * One_P ) ^ 0  ,
                ( function (s,t) return s + t end ) ) : match ( key_value )
    end
  }

\endinput
%%
%% End of file `piton.sty'.
